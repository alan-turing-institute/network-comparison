---
title: "Quick start guide for Netdis - 2 graphs"
author: "Martin O'Reilly, Jack Roberts"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quick start for Netdis - 2 graphs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Load required libraries
```{r}
# Load libraries
library("netdist")
library("purrr")
```

## Set Netdis parameters
```{r}
# Maximum graphlet size to calculate counts for.
# We choose the specific graphlet size for the Netdis metric later.
max_graphlet_size = 4

# Ego network neighbourhood size
neighbourhood_size = 2

# Minimum size of ego networks to consider
min_ego_nodes <- 3
min_ego_edges <- 1

# Ego network density binning parameters
min_bin_count <- 5
num_bins <- 100
```

## Load graphs

```{r}
# Set source directory for Virus PPI graph edge files
source_dir <- system.file(file.path("extdata", "VRPINS"), package = "netdist")

# Load query graphs
graph_1 <- read_simple_graph(file.path(source_dir, "EBV.txt"),
                             format = "ncol")

graph_2 <- read_simple_graph(file.path(source_dir, "ECL.txt"),
                             format = "ncol")

# Load reference graph
ref_path <- system.file(file.path("extdata", "random", "ER_1250_10_1"), 
                        package = "netdist")
ref_graph <- read_simple_graph(ref_path, format = "ncol")
```

## Generate ego networks
```{r}
# Get ego networks for query graphs and reference graph
ego_1 <- make_named_ego_graph(graph_1, 
                              order = neighbourhood_size, 
                              min_ego_nodes = min_ego_nodes, 
                              min_ego_edges = min_ego_edges)

ego_2 <- make_named_ego_graph(graph_2, 
                              order = neighbourhood_size, 
                              min_ego_nodes = min_ego_nodes, 
                              min_ego_edges = min_ego_edges)

ego_ref <- make_named_ego_graph(ref_graph, 
                                order = neighbourhood_size, 
                                min_ego_nodes = min_ego_nodes, 
                                min_ego_edges = min_ego_edges)
```

## Count graphlets in ego networks
```{r}
# Count graphlets for ego networks in query and reference graphs
graphlet_counts_1 <- ego_to_graphlet_counts(ego_1, max_graphlet_size = max_graphlet_size)
graphlet_counts_2 <- ego_to_graphlet_counts(ego_2, max_graphlet_size = max_graphlet_size)
graphlet_counts_ref <- ego_to_graphlet_counts(ego_ref, max_graphlet_size = max_graphlet_size)
```

### Generate scaled graphlet counts for reference graph.
```{r}

# Scale ego-network graphlet counts by dividing by total number of k-tuples in
  # ego-network (where k is graphlet size)
ego_graphlet_tuples_ref <- 
    count_graphlet_tuples_ego(ego_ref, max_graphlet_size = max_graphlet_size)

scaled_graphlet_counts_ref <- scale_graphlet_count(graphlet_counts_ref, ego_graphlet_tuples_ref)
```

## Define function for mapping ego networks to density bins
```{r}

# Get ego-network densities
densities_ref <- purrr::simplify(purrr::map_dbl(ego_ref, igraph::edge_density))

# Adaptively bin ego-network densities
binned_densities <- binned_densities_adaptive(
  densities_ref, min_counts_per_interval = min_bin_count, num_intervals = num_bins)

# Average graphlet counts across density bins
density_binned_graphlet_counts <- mean_density_binned_graphlet_counts(
  scaled_graphlet_counts_ref, binned_densities$interval_indexes)
  
```

## Function to calculate expected graphlet counts for a query network

```{r}

# Ew : density_binned_graphlet_counts
# bins: binned_densities$breaks

# fn (ego, Ew, bins)
# make partial with Ew, bins given



#netdis_expected_graphlet_counts_ego(
#  graph, max_graphlet_size, neighbourhood_size,
#  density_breaks, density_binned_reference_counts,
#  min_ego_nodes = 3, min_ego_edges = 1)

  # Generate ego-networks for query graph
  # no - pass in pre-calculated ego networks
  # remove params graph, neighbourhood_size, min_ego_nodes, min_ego_edges
  # add param ego_networks

  # Map over query graph ego-networks, using reference graph statistics to 
  # calculate expected graphlet counts for each ego-network.
#  expected_graphlet_counts <- 
#    purrr::map(ego_networks, netdis_expected_graphlet_counts,
#               max_graphlet_size = max_graphlet_size,
#               density_breaks = density_breaks,
#               density_binned_reference_counts = density_binned_reference_counts)
#  names(expected_graphlet_counts) <- names(ego_networks)
#  # Simplify list to array
#  t(simplify2array(expected_graphlet_counts))
```

## Centre and scale graphlet counts of query graphs based on statistics of reference graph
```{r}
#query_ego_centred_graphlet_counts <- CENTRED_COUNTS(query_ego_subraph_counts, REF_COUNTS)
```

## Sum centred counts across all ego networks
```{r}
#query_sum_centred_graphlet_counts <- SUM_SUBGRAPH_COUNTS(query_ego_centred_subgraph_counts)
```

## Calculate netdis statistics
```{r}
#NETDIS_STATISTIC(query_sum_centred_graphlet_counts)
```

## Display results
```{r}

```